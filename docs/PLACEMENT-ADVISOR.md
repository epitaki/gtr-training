# PlacementAdvisor 配置推薦システム設計書

## 概要

`PlacementAdvisor` はフィールドの現在の状態と手駒（ぷよペア）を入力として、
GTR完成に向けた最適な配置位置を推薦するシステムである。

- ソースコード: [PlacementAdvisor.ts](../src/game/PlacementAdvisor.ts)
- 設定ファイル: [PlacementAdvisorConfig.ts](../src/game/PlacementAdvisorConfig.ts)
- シミュレーション: [simulate-advisor.ts](../scripts/simulate-advisor.ts)

---

## アーキテクチャ

```
getAdvice(field, currentPair, nextPair?)
  │
  ├─ detectPhase(grid)              ← フェーズ判定
  │
  ├─ 全配置候補を列挙（4回転 × 6列）
  │   │
  │   ├─ simulateLanding()          ← 着地位置計算（重力考慮）
  │   ├─ applyPlacement()           ← 仮配置グリッド生成
  │   │
  │   ├─ scoreFoldProgress()        ← ① 折り返し進捗スコア
  │   ├─ scoreChainTail()           ← ② 連鎖尾スコア（パターン構築ガイド）
  │   ├─ scoreConnectivity()        ← ③ 同色連結スコア
  │   ├─ scoreHeightPenalty()       ← ④ 高さペナルティ
  │   ├─ scoreChainSimulation()     ← ⑤ 連鎖シミュレーション
  │   └─ evaluateLookahead()        ← ⑥ ネクスト先読み（nextPairの最善評価）
  │
  │   totalScore = Σ(スコア × フェーズ別重み) + lookaheadScore × DISCOUNT
  │
  └─ スコア降順ソート → bestPlacement を返却
```

---

## 1. フェーズシステム

ゲームの進行状況に応じて3つのフェーズを自動検出し、各スコアラーの重みを切り替える。

### フェーズ遷移

```
FOLD_BUILDING ──[GTR検出]──→ CHAIN_TAIL ──[連鎖尾6個以上]──→ COMPLETION
```

| フェーズ | 条件 | 目的 |
|----------|------|------|
| `FOLD_BUILDING` | GTR未検出 | 折り返し構築に集中 |
| `CHAIN_TAIL` | GTR検出済み & 連鎖尾 < 6個 | 連鎖尾を伸ばす |
| `COMPLETION` | GTR検出済み & 連鎖尾 >= 6個 | GTR仕上げ |

### フェーズ別重み（ADVISOR_WEIGHTS）

| スコアラー | fold_building | chain_tail | completion |
|------------|:------------:|:----------:|:----------:|
| foldProgress | **4.0** | 0.5 | 0.2 |
| chainTail | 0.3 | **1.0** | **1.0** |
| connectivity | 1.0 | 1.0 | 1.0 |
| heightPenalty | 1.5 | 1.0 | 1.0 |
| chainSim | 0.0 | **5.0** | **5.0** |

`fold_building` では `foldProgress` が支配的（×4.0）で、折り返し構築を最優先する。
`chainSim` はGTR完成前には計算しない（0.0）。

---

## 2. GTRテンプレートマッチング

### テンプレート定義

GTRの折り返しは7つのターゲット位置で構成される。色A/Bは全12通り試行して最適を選択。

```
col:    0    1    2
       ┌────┬────┐
h-3:   │ A  │ B  │          ← 優先度3（P3）
       ├────┼────┼────┐
h-2:   │ A  │ A  │ B  │     ← 優先度2（P2）
       ├────┼────┼────┘
h-1:   │ B  │ B  │          ← 優先度1（P1）
       └────┴────┘
```

- **優先度1 (P1)**: 最下段 (0,12)(1,12) = 色B×2
- **優先度2 (P2)**: 中段 (0,11)(1,11) = 色A×2, (2,11) = 色B
- **優先度3 (P3)**: 上段 (0,10)(1,10) = 色A, 色B

### 色割り当て探索

```
scoreFoldProgress()
  ├─ 全12通りの(A,B)色組み合わせで evaluateTemplate() を呼ぶ
  ├─ 最高スコアを採用
  ├─ 全組み合わせが矛盾（-Infinity）の場合 → エリアペナルティのみ返却
  └─ bestScore + scoreFoldAreaPenalty() を返却
```

既存フィールドの色と矛盾する(A,B)組み合わせは即座に `-Infinity` で除外される。
例: (0,12)=赤 のとき (A,B)=(緑,青) は B=青≠赤 で矛盾 → -Infinity

### テンプレートマッチスコア

配置したぷよがテンプレート位置に着地した場合のスコア:

| 条件 | スコア |
|------|--------|
| P1正解 | +30 |
| P2正解 | +30 |
| P3正解 | +30 |
| 間違った色を置いた | **-50** |

### 前提条件チェック（構築順序の強制）

GTRは下から順に積む必要がある。上位の配置を急ぐと暴発リスクが生じるため、
前提が未充足の場合はボーナスに `PREREQUISITE_PENALTY (0.3)` を乗算する。

| 対象 | 前提条件 | 未充足時のスコア |
|------|----------|------------------|
| P2 | P1が全て正しい色 | 30 × 0.3 = **9** |
| P3 | **P1が全て正しい色** | 30 × 0.3 = **9** |

**P3の前提条件がP1のみの理由:**

P3は(0,10)と(1,10)であり、重力により直下の(0,11)と(1,11)が埋まっていなければ配置不可能。
つまりP3配置時点でP2位置は物理的に充填済み。色の正しさは`evaluateTemplate`の
矛盾チェック（-Infinity）が保証するため、P2色チェックは不要。
旧実装ではP2 col0-1の色正解を要求していたが、過剰に厳しくP3完成率を下げていた。

---

## 3. 折り返しエリアペナルティ

`scoreFoldAreaPenalty()` はテンプレートマッチとは独立に、
配置位置の「エリア」に基づくペナルティを加算する。

```
配置されたぷよの位置を判定:

  col0-2, y < h-3   →  TOO_HIGH_ON_FOLD_SIDE (-20)  高すぎる
                        ※P3テンプレート直上(h-4)は P3_COMPANION_TOO_HIGH (-3) に軽減
  col0-2, (2,h-1) & P1完了 & (2,h-2)空  →  STEPPING_STONE_BONUS (+15)  踏み台
  col0-2, (2,h-3) & P2(2,h-2)完了      →  CHAIN_TAIL_CONNECTION (0)  接続点
  col0-2, テンプレート外  →  NON_TARGET_FOLD_PENALTY (-7)  (2,10)等
  それ以外           →  OUTSIDE_FOLD_PENALTY (0)        ペナルティなし
```

| 定数 | 値 | 意味 |
|------|-----|------|
| `TOO_HIGH_ON_FOLD_SIDE` | -20 | col0-2でrow9以上に積む（折り返しが高くなりすぎ） |
| `P3_COMPANION_TOO_HIGH` | **-3** | P3テンプレート直上(h-4)のコンパニオンは軽減（P3縦置き促進） |
| `STEPPING_STONE_BONUS` | **+15** | (2,12)踏み台: P1完了後にのみ適用し(2,11)到達を強力促進 |
| `CHAIN_TAIL_CONNECTION` | 0 | (2,h-3)連鎖尾接続点: P2(2,h-2)完了後はペナルティなし |
| `NON_TARGET_FOLD_PENALTY` | **-7** | (2,10)などテンプレート外の折り返しエリア |
| `OUTSIDE_FOLD_PENALTY` | 0 | 連鎖尾エリア（ペナルティなし） |

**`STEPPING_STONE_BONUS` の仕組み:**
(2,11)=Bを埋めるには(2,12)に先にぷよを置く必要がある（物理的な踏み台）。
しかし(2,12)はテンプレート外のため`NON_TARGET_FOLD_PENALTY`で忌避される。
P1完成後かつ(2,11)未充填のときのみ、(2,12)に+15のボーナスを付与し踏み台充填を強力促進する。
P1未完了時は通常のペナルティ(-7)を維持してP1構築の妨害を防ぐ。

**`P3_COMPANION_TOO_HIGH` の仕組み:**
P3配置（例: A→(0,10)）では必然的にコンパニオンぷよが(0,9)に行く。
通常の`TOO_HIGH(-20)`だとP3配置のコストが高すぎるため、
P3テンプレート直上の位置のみ`-3`に大幅軽減し、P3縦置きを積極的に促進する。

**`OUTSIDE_FOLD_PENALTY = 0` の理由:**
折り返し構築フェーズでも off-color のぷよは連鎖尾に積むべきであり、
エリア外ペナルティをかけると連鎖尾が育たず後半に苦しむ。

---

## 4. 連鎖尾スコア（scoreChainTail）

連鎖尾エリア（col 3-5）への配置を、パターン構築品質に基づいて評価する。

### 研究背景

YouTube動画「【ぷよ研究】GTRの後ろの形を分析してみました」(TlVwMVFA2co)の分析結果:
- GTRの連鎖尾は**403パターン**存在（3列目〜6列目、下4段、3色、4連鎖まで）
- **Y字型が圧倒的に優秀**（バリエーション最多＝様々な色配列に対応可能）
- 連鎖尾の型のランキング: Y字 > L字 > トの字
- Y字には2Y型（5列目まで）と3Y型（6列目まで）の2バリエーション

### スコアリング要素

| 条件 | スコア | 意味 |
|------|--------|------|
| col 3-5 に配置 | +10 | エリア配置ボーナス |
| 横方向同色隣接（連鎖尾エリア内） | +8 | 連鎖構築に必要な横方向のグルーピング |
| 最下段(h-1)配置 | +5 | 底部から順に充填を促進 |
| 2段目(h-2)配置 | +3 | 下段優先の段階的構築 |
| 列に2色以上のレイヤー | +5/列 | 異なる色の層構造（連鎖の基盤） |
| col3-5の高さ差≤1 | +5 | Y字型に近いバランスの良い構造 |
| y < h-4（高すぎる） | -10 | 不安定な高積みを抑制 |

### Y字型促進の仕組み

Y字型はcol3-5の高さが均等に近い形。`BALANCED_HEIGHT_BONUS`により
高さ差≤1の場合にボーナスを付与し、Y字型構造への誘導を行う。
また`HORIZONTAL_ADJACENCY_BONUS`で横方向の同色連結を促進し、
連鎖が正しく発火する配置を優遇する。

---

## 5. 同色連結スコア（scoreConnectivity）

配置後のグリッドで、配置したぷよを起点にfloodFillし、連結グループのサイズを評価。

| グループサイズ | 条件 | スコア | 説明 |
|----------------|------|--------|------|
| 4以上 | - | **-500** | 暴発（即消え）→ fold matchボーナスを完全に打ち消す |
| 3 | 縦3積み | -10 | 理想形の連鎖尾を阻害 |
| 3 | 折り返しエリア内（非テンプレート含む） | **-100** | 暴発リスク大 |
| 3 | その他 | +20 | 連鎖構築に有益 |
| 2 | - | +10 | 適度な連結 |
| 1 | - | 0 | 孤立 |

### 折り返しエリア3連結の判定ロジック（isFoldAreaGroup）

テンプレート位置**のみ**で構成される3-groupは正常なGTR構築なのでOK(+20)。
非テンプレート位置（(2,12)や(2,10)）を含む3-groupは暴発リスクとして-100。

```
例: OK（テンプレートのみ）
  A(0,11) + A(1,11) + A(0,10) → +20

例: NG（非テンプレート含む）
  B(0,12) + B(1,12) + B(2,12) → -100
  ※ (2,12)は非テンプレート → 次にB(2,11)が来ると4連結暴発
```

---

## 6. 高さペナルティ（scoreHeightPenalty）

フィールド全体の高さに対するペナルティ。

| 条件 | スコア |
|------|--------|
| y <= 2（最上部付近） | -30 |
| y <= 4（危険ゾーン） | -15 |

---

## 7. 連鎖シミュレーション（scoreChainSimulation）

`CHAIN_TAIL` / `COMPLETION` フェーズのみ有効（`FOLD_BUILDING` では0）。
`GTRDetector.detectGTR()` を使い、配置後の連鎖数を評価。

| 条件 | スコア |
|------|--------|
| GTRパターン検出 | +10 |
| 連鎖1つにつき | +15 |

---

## 8. ネクスト先読み（evaluateLookahead）

currentPairの配置を決定する際に、nextPairの最善スコアも考慮する1手先読みシステム。

### 仕組み

```
currentPairの各候補配置に対して:
  1. gridAfterCurrent = 配置後のグリッド
  2. nextPairの全配置候補を軽量スコアリング（chainSimはスキップ）
  3. bestNextScore = nextPairの最善スコア
  4. totalScore += bestNextScore × DISCOUNT(0.4)
```

### 設定

| 定数 | 値 | 意味 |
|------|-----|------|
| `LOOKAHEAD.ENABLED` | true | 先読みの有効/無効 |
| `LOOKAHEAD.DISCOUNT` | 0.4 | nextPairスコアの重み（currentの40%） |

### パフォーマンス

- 計算量: ~22候補 × 22候補 = ~484回の軽量評価
- chainSimをスキップして高速化（floodFill + 重力シミュ不要）
- getAdviceはフレーム毎ではなく手駒確定時のみ呼ばれるため許容範囲

### DISCOUNT値の根拠

- 1.0だとnextPairが支配的になり、目前の折り返し進捗を犠牲にする
- 0.4は「next手に絶望的な配置（例: -200点）を避けつつ、current手の判断は維持」するバランス

---

## 9. スコア計算の具体例

### 例1: P1配置（最も基本的なケース）

手駒: BB（青-青）、フィールド: 空

```
配置: col0, rot→ (横右) → B(0,12) + B(1,12)

foldProgress:
  evaluateTemplate: P1正解×2 = +30 + +30 = +60
  areaScore: 0 (テンプレート位置)
  → 60
chainTail: 0 (col0-2)
connectivity: B(0,12)+B(1,12) = 2-group → +10
heightPenalty: 0
chainSim: 0 (fold_building)

total = 60×4.0 + 0×0.5 + 10×1.0 + 0×1.5 + 0
      = 240 + 0 + 10 + 0 + 0 = 250
```

### 例2: P3配置（伴走ぷよが高くなるケース）

手駒: AB（P3色A + off-color）、P1+P2(col0-1)完成済み

```
配置: col0, rot↑ (縦) → A(0,10) + B(0,9)

foldProgress:
  evaluateTemplate: P3正解 = +30 (前提充足: ×1.0)
  areaScore: (0,10)テンプレート=0, (0,9)P3_COMPANION_TOO_HIGH=-3 → -3
  → 30 + (-3) = 27
chainTail: 0
connectivity: A(0,10)+A(0,11)=2-group → +10, B(0,9)=孤立 → 0
heightPenalty: 0
chainSim: 0

total = 27×4.0 + 0 + 10×1.0 + 0 + 0 = 118
```

比較: 同じ手駒を連鎖尾に配置した場合 → 約17（chainTail×0.3+connectivity）
→ P3配置(118) > 連鎖尾(17) で正しく折り返し優先。

### 例3: 間違った色をテンプレート位置に置くケース

手駒: GR、テンプレート A=赤, B=青

```
配置: col1, rot↑ → G(1,11) + R(1,10)

foldProgress:
  evaluateTemplate for A=R, B=B:
    G(1,11) needs A=R → G≠R → WRONG_COLOR = -50
    R(1,10) needs B=B → R≠B → WRONG_COLOR = -50
    → -100
  → -100 × 4.0 = -400

→ 大きな負値 → この配置は選択されない
```

---

## 9. -Infinity フォールバック

全12通りの(A,B)色割り当てが既存フィールドと矛盾する場合、
`bestScore` が `-Infinity` のままになる。

この場合、テンプレートスコアを無視してエリアペナルティのみで判定する。
これにより「折り返しが壊れた状態」でも連鎖尾への誘導が正常に機能する。

```typescript
if (!isFinite(bestScore)) {
  return areaScore  // テンプレートスコアを諦め、位置ペナルティのみ
}
```

---

## 10. 着地シミュレーション

`simulateLanding()` は重力を考慮して各列の最下空行を探索する。

| 回転 | sub位置 | main位置 |
|------|---------|----------|
| 0（↑） | main の上 | 最下空行 |
| 1（→） | main の右列 | 各列独立に最下空行 |
| 2（↓） | main の下 | 最下空行-1 |
| 3（←） | main の左列 | 各列独立に最下空行 |

列範囲制限:
- rot0/2: col 0-5
- rot1: col 0-4（subが右にはみ出さない）
- rot3: col 1-5（subが左にはみ出さない）

---

## 11. チューニング履歴

| 変更 | Before | After | 効果 |
|------|--------|-------|------|
| WRONG_COLOR_PENALTY | -25 | **-50** | 間違い色配置を確実にブロック |
| PRIORITY_1_MATCH | 20 | **30** | P1をNON_TARGETペナルティと組でも正に |
| PRIORITY_2_MATCH | 18 | **30** | P2完成を強力に推進 |
| PRIORITY_3_MATCH | 15 | **30** | TOO_HIGH(-20)を克服して連鎖尾に勝つ |
| PREREQUISITE_PENALTY | 0.5 | **0.3** | 構築順序を強く強制 |
| OUTSIDE_FOLD_PENALTY | -5 | **0** | 連鎖尾への自然な誘導 |
| NON_TARGET_FOLD_PENALTY | (新設) | **-10** | (2,12)等の無秩序配置を抑制 |
| GROUP_SIZE_3 | 25 | **20** | テンプレートマッチ優先 |
| GROUP_SIZE_3_FOLD | (新設) | **-100** | 折り返し内3連結の暴発防止 |
| GROUP_SIZE_3_VERTICAL | (新設) | **-10** | 縦3積みの抑制 |
| GROUP_SIZE_4_PLUS | -20 | **-500** | fold matchボーナスを完全に打ち消す暴発防止 |
| chainTail weight (fold_building) | 0.0 | **0.3** | off-color を連鎖尾に誘導（fold優先のため抑制） |
| connectivity weight (fold_building) | 0.5 | **1.0** | 有意義な連結を促進 |
| P3前提条件 | 全P2完成 | **P1完了のみ** | 重力+矛盾チェックで色正しさ保証、P3完成率UP |
| -Infinity処理 | なし | **areaScore返却** | 折り返し崩壊時の推薦ランダム化防止 |
| STEPPING_STONE_BONUS | (新設) | **+15** | P1完了後に(2,12)充填を強力促進→(2,11)到達率UP |
| P3_COMPANION_TOO_HIGH | (新設) | **-3** | P3縦置きコスト大幅軽減（-20→-3）でP3充填を促進 |
| NON_TARGET_FOLD_PENALTY | (新設) | **-7** | コンパニオン配置を許容しつつ暴発防止はGROUP_SIZE_3_FOLDに委任 |
| CHAIN_TAIL_CONNECTION | (新設) | **0** | (2,h-3)連鎖尾接続点: P2完了後はペナルティなし |
| ネクスト先読み | (新設) | **DISCOUNT=0.4** | nextPairの最善スコアを40%重みで加算 |
| 連鎖尾強化（横隣接） | (新設) | **+8** | 横方向同色隣接でグルーピング促進 |
| 連鎖尾強化（底部充填） | (新設) | **+5/+3** | 下段から順に充填を誘導 |
| 連鎖尾強化（レイヤー） | (新設) | **+5/列** | 2色以上のレイヤー構造で連鎖基盤形成 |
| 連鎖尾強化（バランス） | (新設) | **+5** | Y字型に近い均等な高さ構造 |

---

## 12. シミュレーション結果

10000ゲーム×ランダムペア生成（2手制約付き）での成功率（3回平均）:

| ターン数 | 成功率 (v2) | 成功率 (v3) | 成功率 (v3.2) |
|----------|-------------|-------------|---------------|
| 10手 | 72.8% | 81.2% | **83.1%** (+1.9) |
| 12手 | 85.5% | 90.0% | **91.9%** (+1.9) |
| **15手** | 93.0% | 96.4% | **97.1%** (+0.7) |
| 20手 | 98.1% | 99.3% | **99.5%** (+0.2) |

### チューニング前後の比較（15手）

| 段階 | 成功率 | 主な変更 |
|------|--------|----------|
| テンプレートv2初期 | 56.5% | 基本実装 |
| P3_MATCH強化 | 87.7% | P3_MATCH 15→30 |
| P3前提条件修正 | 91.0% | col0-1のP2のみチェック |
| 踏み台+P3軽減 | 93.0% | STEPPING_STONE+P3_COMPANION |
| v3: 先読み+連鎖尾強化 | 96.4% | ネクスト先読み+連鎖尾パターンスコアリング |
| **v3.2: パラメータ最適化** | **97.1%** | 暴発根絶+P3前提緩和+踏み台強化 |

### v3.2の主な改善（v3→v3.2）

| 変更 | 効果 |
|------|------|
| GROUP_SIZE_4_PLUS: -150→**-500** | 暴発60件→**2件**（ほぼ根絶） |
| P3前提条件: P2 col0-1→**P1のみ** | P3未完成率を改善 |
| STEPPING_STONE: 5→**15** | (2,11)到達率向上 |
| chainTail weight (fold): 0.5→**0.3** | fold中の連鎖尾引力を抑制 |
| P3_COMPANION: -10→**-3** | P3縦置きコスト大幅軽減 |
| NON_TARGET_FOLD: -10→**-7** | コンパニオン配置の許容度向上 |

### 残存する失敗パターン（15手、全体の~3%）

| カテゴリ | 件数(10000中) | 割合 | 原因 |
|----------|-------------|------|------|
| P3未完成 | ~156 | ~54% | 必要色ペアの未到達（確率的限界） |
| P2未完成 | ~81 | ~28% | (2,11)到達・色可用性の確率的限界 |
| 暴発 | ~2 | ~1% | v3.2でほぼ根絶 |
| その他 | ~50 | ~17% | フィールド混雑等 |

v2→v3→v3.2で継続改善: P3 360→195→156件、BURST 110→60→2件
15手での理論限界は~97-98%（ランダムペア生成の色可用性制約による）

---

## 13. ファイル構成

```
src/game/
├── PlacementAdvisor.ts         ← メインロジック（本ドキュメントの対象）
├── PlacementAdvisorConfig.ts   ← 全スコアリング定数（チューニング時はここを変更）
├── GTRPatterns.ts              ← GTR検出（フェーズ判定・連鎖シミュに使用）
└── types.ts                    ← GameField, PuyoPair 等の型定義

scripts/
└── simulate-advisor.ts         ← 検証用シミュレーションスクリプト
                                   npx tsx scripts/simulate-advisor.ts で実行
```

---

## 14. GTR連鎖尾の研究背景

### 参考動画

**【ぷよ研究】GTRの後ろの形を分析してみました** (YouTube: TlVwMVFA2co)

計算機を使ってGTRの連鎖尾パターンを全数分析した研究動画:
- 制約条件: 3列目〜6列目（0-indexed: col2-5）、下4段、3色、4連鎖以内
- 結果: **403パターン**が存在
- GTR直後の連鎖形でグルーピングすると**18パターン**
- さらに次の連鎖形でグルーピングすると**20パターン**

### 連鎖尾の型ランキング（バリエーション数順）

| 順位 | 型 | 特徴 |
|------|-----|------|
| **1位** | **Y字** | バリエーション最多。2Y型(5列目まで)と3Y型(6列目まで)あり |
| 2位〜5位 | 各種（L字等） | 中程度のバリエーション |
| 下位 | 3色4連鎖型等 | パターン数1〜数個 |

### 設計への反映

1. **Y字型優遇**: `BALANCED_HEIGHT_BONUS`でcol3-5の高さを均等に誘導
2. **レイヤー構造**: `LAYER_BONUS`で異色レイヤーの形成を促進
3. **横方向グルーピング**: `HORIZONTAL_ADJACENCY_BONUS`で連鎖発火に必要な横連結を促進
4. **底部充填**: `BOTTOM_ROW_BONUS`/`SECOND_ROW_BONUS`で下段から順に構築

### 参考リンク

- [GTR連鎖尾パターン全403種 (スプレッドシート)](https://docs.google.com/spreadsheets/d/1VXEz-QPJ5VtTJX9sCplW6jeJ8dvAygcYcO0uiyeB-5M/edit)
- [GTR完全攻略: 土台まとめ](https://keepuyo.com/gtrmaster-base/)
- [GTR完全攻略: 連鎖尾まとめ](https://keepuyo.com/gtrmaster-tails/)
- [9割の人が使う形「GTR」のつくり方](https://puyo-camp.jp/posts/169779)
