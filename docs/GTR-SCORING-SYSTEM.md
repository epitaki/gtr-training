# GTR評価システム設計書

## 概要
GTRパターンの評価をロジックベースで実装したシステムです。note.mdの仕様に基づいて実装されています。

## 評価システムの構成

### 1. 評価範囲

#### note.mdに基づく評価範囲
```
1 2 3 4 5 6
_ _ / / / /  ← 9行目：3-6列目のみ評価
/ / / / / /  ← 10行目：全列評価
/ / / / / /  ← 11行目：全列評価
/ / / / / /  ← 12行目：全列評価（最下段）
```

- 1-2列目: 10-12行目
- 3-6列目: 9-12行目

### 2. GTR必須形状の評価: 100-120点

#### 必須の折り返しパターン
```
1 2 3
A B _  ← 10行目：1列目A、2列目B
A A B  ← 11行目：1-2列目A、3列目B
B B _  ← 12行目：1-2列目B（最下段）
```

**評価:**
- 基本GTR（10-12行目）: 100点
- 拡張GTR（9行目まで使用）: 120点
- **折り返しがない場合: 0点（GTRではない）**

### 3. 連鎖数評価: 最大50点

#### 連鎖数の数え方（note.md仕様）
- (1,9)に(1,10)と同じ色が来たときの連鎖を評価
- 評価範囲内のぷよを使った連鎖数をカウント

**評価:**
- 1連鎖あたり: 10点
- 最大評価: 5連鎖（50点）

### 4. 9行目の使用状況評価: 最大15点

#### 右上が立っている形の評価（note.md仕様）
- (6,9)だけ使用: 15点（最高評価 - 理想形）
- (5,9)と(6,9)だけ使用: 10点（高評価）
- 右側にある: 5点（普通）
- それ以外: 0点

### 5. あまりぷよ評価: 最大20点

#### あまりぷよの定義（note.md仕様）
- 評価範囲内で連鎖に使われなかったぷよ
- 同じ色で連結していることが重要

**評価:**
- あまりぷよなし: 20点（最高評価）
- **複数色のあまりぷよ: 0点**（連結していても評価しない）
- 単一色、3つ完全連結: 18点（最大連結）
- 単一色、2つ完全連結: 15点
- 単一色だが分離: 5点

※ 4連結は消えるため、あまりぷよとして存在しない

## 総合スコア計算

### 計算式
```
総合スコア = (基本形スコア × 0.5) + (連鎖尾スコア × 0.5)

連鎖尾スコア = 連鎖数ボーナス + 9行目評価 + あまりぷよ評価
```

### 評価タイミング（note.md仕様）
- Spaceキーを押したときに評価
- 評価結果を2秒間表示後、ゲームをリセット

## 実装ファイル

### 評価ロジック
- `src/game/GTRPatterns.ts` - GTR評価ロジック
- `src/game/GTRScoringConfig.ts` - 点数設定（チューニング用）

### 設定ファイルでのチューニング
`GTRScoringConfig.ts`を編集することで、各評価項目の点数を簡単に調整可能です。

## 評価メッセージ

### 連鎖数に応じたメッセージ
- 5連鎖以上: 「素晴らしい！{chain}連鎖のGTR！」
- 4連鎖: 「良いGTR！{chain}連鎖達成」
- 3連鎖: 「GTR完成！{chain}連鎖」
- それ以下: 「GTR形状確認。連鎖数: {chain}」
- GTRではない: 「GTRの必須折り返しがありません」

## メリット

1. **透明性**: プレイヤーが評価基準を理解しやすい
2. **調整可能**: configファイルを変更するだけでバランス調整が可能
3. **拡張性**: 新しい評価軸を簡単に追加できる
4. **学習効果**: どこを改善すべきか明確
5. **実装効率**: 400種類を定義するより遥かに少ない工数

## デメリットと対策

| デメリット | 対策 |
|------------|------|
| 特殊パターンの評価が難しい | 有名パターン10-20種類のみ個別ボーナス |
| 完璧な評価は困難 | ユーザーフィードバックで継続改善 |
| 初期調整が必要 | プレイテストで係数を調整 |

## 現在の実装状況

### ✅ 実装済み
1. **GTR必須形状の検出**
   - 1-3列目の折り返しパターン確認
   - 基本/拡張GTRの判定

2. **連鎖数評価**
   - 簡易シミュレーションによる推定
   - 最大5連鎖まで評価

3. **9行目評価**
   - 右上の立ち具合を評価

4. **あまりぷよ評価**
   - 連結グループのDFS探索
   - 複数色で0点判定

5. **設定ファイル分離**
   - GTRScoringConfig.tsで点数管理

## まとめ

note.mdの仕様に基づいたロジックベースの評価システムを実装しました。

### 主な特徴
- **評価範囲**: 1-2列目は10-12行目、3-6列目は9-12行目
- **必須折り返し**: なければ0点
- **連鎖数**: 最大5連鎖まで評価
- **あまりぷよ**: 同色連結で高評価、複数色で0点
- **設定分離**: 点数チューニングが容易

これにより、プレイヤーがGTRの正しい形を学習しやすくなりました。