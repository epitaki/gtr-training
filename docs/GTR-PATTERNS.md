# GTR（グレート田中連鎖）パターン定義

このドキュメントは、GTRトレーニングツールで使用するGTRパターンの定義と評価基準を説明します。

## 概要

**GTR（グレート田中連鎖）**は、ぷよぷよにおける効率的な連鎖の土台形です。
本ツールでは**標準GTR**と(左に折り返しがある形)のみを対象とし、逆折りGTRは複雑すぎるため対象外としています。

## GTRの構造

**重要**: GTRには必ず折り返し部分が存在します。折り返しのないGTRは存在しません。

GTRは以下の2つの部分で構成されます：
1. **折り返し部分**（必須）：1-3列目の特定の形状
2. **連鎖尾**：折り返しの右側(3列目も含む)の連鎖を伸ばす部分

## 先折りGTR初手パターン（4分類）

GTRを効率的に組むには、最初の2手（4つのぷよ）を分類して配置を定型化することが重要。
初手パターンは以下の4型に分類される（参考: ぷよぷよキャンプ・keepuyo.com調査）。

### 型1: AAAB（同色3+異色1）
- 初手を3列目にA上の縦置き、2手目を1-2列目に横置き
- 例: 赤赤赤緑 → 赤を3列目縦置き → 緑赤を1-2列目横置き

### 型2: ABAB / AABB（交互 or 対）
- 横置きで土台を形成。ABの位置は逆でもOK
- 最もシンプルに折り返しが組める型

### 型3: ABAC（2色含み）
- Aを下にして1列目に縦置き、またはAを左にして2-3列目に横置き
- Cが不要色の場合は右側（4-6列目）に捨てる

### 型4: AABC（同色2+異色2）
- 初手の置き方を固定して配置
- BCが折り返しに使えない場合は右側に捨てる

**共通原則**: 折り返しに不要なぷよは右側（4-6列目）に捨てる。

## 対象GTRパターン

### 1. GTRの基本形（必須折り返し部分）

すべてのGTRに共通する必須の形状です。折り返し部分は1列目から始まります。

```
フィールド座標（列1-6、行1-12、12行目が最下段）:
1 2 3 4 5 6
A B _ _ _ _  ← 10行目：1列目A色、2列目B色
A A B _ _ _  ← 11行目：1-2列目A色、3列目B色
B B _ _ _ _  ← 12行目：1-2列目B色（最下段）
```

**特徴:**
- **必須形状**: この配置がなければGTRではない
- **A色**: 10行目1列目 + 11行目1-2列目に配置（L字型）
- **B色**: 10行目2列目 + 11行目3列目 + 12行目1-2列目に配置（逆L字型）
- **折り返し**: 1列目でA色とB色が上下に折り返す形

**評価基準:**
- 基本スコア: 100点
- 必須列: 1列目、2列目、3列目
- 最低限必要な色数: 2色（A、B）

## 連鎖尾の配置パターン

GTRの連鎖尾（3列目以降）の理想的な配置パターンです。
連鎖尾は3列目のB色が消えた後に連鎖が繋がるように配置します。

### 連鎖尾の強さランキング（ぷよぷよキャンプ 403パターン調査に基づく）

3-6列目・下4段・4連結限定の条件で全パターンを列挙した研究結果:
1. **Y字形**: バリエーション数が最も多く、柔軟性が高い → 初心者に最も推奨
2. **横3形（座布団形）**: Y字に次いでバリエーションが豊富
3. **だぁ積み形**: 中級者向け
4. **L字形**: バランスは良いがバリエーションは少なめ
5. **階段形**: 連鎖数は伸ばしやすいが難易度が高い

※ 以下のパターンはGTRGuidePatterns.tsの実装に基づいています。
※ 評価順: Y字形 > 座布団形 > L字形 > 階段形

### 1. Y字形（最も理想的 ⭐⭐⭐⭐）

```
1 2 3 4 5 6
A B C _ _    ← 10行目
A A B C C    ← 11行目
B B C _ _    ← 12行目（最下段）
```

- **配置**: GTRの1-2列目 + Y字型連鎖尾3-5列目
- **スコア倍率**: 1.5倍
- **特徴**: 最も安定した連鎖が作りやすく、初心者にも推奨

### 2. 座布団形（推奨 ⭐⭐⭐）

```
1 2 3 4 5 6
A B C _ _ _  ← 10行目
A A B C C C  ← 11行目
B B _ _ _ _  ← 12行目（最下段）
```

- **配置**: GTRの1-2列目 + 横方向連鎖尾3-6列目
- **スコア倍率**: 1.3倍
- **特徴**: 横に広がる安定した配置

### 3. L字形（良い ⭐⭐）

```
1 2 3 4 5 6
A B C _ _    ← 10行目
A A B C _    ← 11行目
B B C C _    ← 12行目（最下段）
```

- **配置**: GTRの1-2列目 + L字型連鎖尾3-4列目
- **スコア倍率**: 1.2倍
- **特徴**: バランスの良い連鎖構築

### 4. 階段形（普通 ⭐）

```
1 2 3 4 5 6
_ _ C _ _    ← 9行目
A B C _ _    ← 10行目
A A B C _    ← 11行目
B B D C _    ← 12行目（最下段）
```

- **配置**: GTRの1-2列目 + 階段状連鎖尾3-4列目
- **スコア倍率**: 1.0倍
- **特徴**: 連鎖数を伸ばしやすいが難易度高め

## GTR完成形の例

GTRGuidePatterns.tsで定義されている完成形パターンです（全バリエーション網羅）。
※ 評価順: Y字形 > 座布団形 > L字形 > 階段形

### Y字形完成形（3バリエーション）⭐⭐⭐⭐

#### Y字形完成形1
```
1 2 3 4 5 6
_ _ _ _ _ D  ← 9行目
A B C A A D  ← 10行目
A A B C C A  ← 11行目
B B C D D A  ← 12行目（最下段）
```

#### Y字形完成形2
```
1 2 3 4 5 6
_ _ _ _ A _  ← 9行目
A B C A D A  ← 10行目
A A B C C D  ← 11行目
B B C D D A  ← 12行目（最下段）
```

#### Y字形完成形3
```
1 2 3 4 5 6
_ _ _ _ A D  ← 9行目
A B C _ A D  ← 10行目
A A B C C A  ← 11行目
B B C D D A  ← 12行目（最下段）
```

- 4色（A,B,C,D）を使用
- 右上に連鎖尾が伸びる理想形

### 座布団形完成形（2バリエーション）⭐⭐⭐

#### 座布団形完成形1
```
1 2 3 4 5 6
_ _ _ _ B B  ← 9行目
A B C B A B  ← 10行目
A A B C C C  ← 11行目
B B D A A A  ← 12行目（最下段）
```

#### 座布団形完成形2
```
1 2 3 4 5 6
_ _ _ _ B B  ← 9行目
A B C B A A  ← 10行目
A A B C C C  ← 11行目
B B D A A B  ← 12行目（最下段）
```

- 4色（A,B,C,D）を使用
- 横に広がる安定形

### L字形完成形（2バリエーション）⭐⭐

#### L字形完成形1
```
1 2 3 4 5 6
_ _ _ _ _ A  ← 9行目
A B C D A A  ← 10行目
A A B C D D  ← 11行目
B B C C D A  ← 12行目（最下段）
```

#### L字形完成形2
```
1 2 3 4 5 6
_ _ _ A _ _  ← 9行目
A B C D A A  ← 10行目
A A B C D A  ← 11行目
B B C C D D  ← 12行目（最下段）
```

- 4色（A,B,C,D）を使用
- L字型に連鎖が繋がる

### 階段形完成形（1バリエーション）⭐

#### 階段形完成形1
```
1 2 3 4 5 6
_ _ C D A B  ← 9行目
A B C D A B  ← 10行目
A A B C D A  ← 11行目
B B C D A B  ← 12行目（最下段）
```

- 4色（A,B,C,D）を使用
- 階段状に連鎖が繋がる

## GTR認識アルゴリズム

### 1. 基本パターン検出

システムは以下の手順でGTRを検出します：

1. **フィールド下部4行をスキャン**（9-12行目）
2. **2-3列目の色パターンを分析**
3. **連続する同じ色の配置をチェック**
   - 2列目: 2つ以上の同じ色が連続
   - 3列目: 2つ以上の同じ色が連続
4. **色の多様性を評価**（2-4色が理想）

### 2. スコア計算（note.md仕様）

```
総合スコア = (基本形スコア × 0.5) + (連鎖尾スコア × 0.5)

連鎖尾スコア = 連鎖数ボーナス + 9行目評価 + あまりぷよ評価
```

#### 評価範囲
- 1-2列目: 10-12行目
- 3-6列目: 9-12行目

#### 評価タイミング
- Spaceキーを押したときに評価
- 評価結果を2秒間表示後、ゲームリセット

### 3. 詳細評価項目

#### GTR必須形状（100-120点）
- 基本GTR（10-12行目のみ）: 100点
- 拡張GTR（9行目まで使用）: 120点
- **折り返しがない場合: 0点（他の評価は行わない）**

#### 連鎖数評価（最大50点）
- 1連鎖あたり: 10点
- 最大評価: 5連鎖（50点）
- (1,9)に(1,10)と同じ色が来たときの連鎖数をカウント

#### 9行目使用状況評価（最大15点）
- (6,9)だけ使用: 15点（右上が立っている理想形）
- (5,9)と(6,9)だけ使用: 10点
- その他右側にある: 5点
- それ以外: 0点

#### あまりぷよ評価（最大20点）
- あまりぷよなし: 20点（最高評価）
- **複数色のあまりぷよ: 0点**（連結していても評価しない）
- 単一色3つ完全連結: 18点
- 単一色2つ完全連結: 15点
- 単一色だが分離: 5点

※ 4連結は消えるため、あまりぷよとして存在しない

## 対象外パターン

以下のGTRパターンは複雑すぎるため対象外です：

### ❌ 逆折りGTR
- 6列目から始まる逆方向の折り返し
- 初心者には複雑すぎる

### ❌ 変則GTR
- 標準形から大きく外れた配置
- 基本習得を優先するため対象外

### ❌ 多重折り返し
- 複数箇所での折り返し
- 上級者向けのため対象外

## 実装における注意点

### コード上の定義
- `GTRPatterns.ts` ファイルで定義
- パターンマッチングによる検出
- リアルタイム評価システム

### 座標系
- 列: 0-5（左から右、0-indexed）
- 行: 0-11（上から下、0-indexed）
- 最下段は11行目（12行×6列のフィールド）

### 色の表現
- パターン定義では A, B, C, D, E で表現
- 実際のゲームでは PuyoColor enum を使用
- null は空のマスを表す

## 実例：GTRシミュレータでの表現

### pndsng.comシミュレータでの例

- シミュレータURL: `https://www.pndsng.com/puyo/`
- URLパラメータでぷよ配置をエンコード可能
- 実際にシミュレータで確認して学習可能

## 参考資料

- [REQUIREMENT.md](../REQUIREMENT.md) - 全体要件
- [ARCHITECTURE.md](../ARCHITECTURE.md) - 技術設計
- `src/game/GTRPatterns.ts` - 実装コード
- [ぷよシミュレータ](https://www.pndsng.com/puyo/) - オンラインでGTRを試せるツール

---
