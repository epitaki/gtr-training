# ぷよ生成システム仕様書

## 概要

GTRトレーニングツールでは、実際のぷよぷよゲームに準拠した「2手目組み合わせ制約」を実装しています。これにより、より現実的な練習環境を提供します。

## 2手目組み合わせ制約

### 基本ルール
- ぷよぷよの2手目（連続する2つのツモ、計4個のぷよ）には制約があります
- **4色全てが揃うことはありません**
- 以下の5種類の組み合わせのみが生成されます

### 対応パターン

#### 1. AAAA型（全て同じ色）
```
ペア1: [A][A]
ペア2: [A][A]
```
- 使用色数: 1色
- 特徴: 連鎖には使いにくいが、土台作りに有用

#### 2. AAAB型（3個同じ + 1個別色）
```
ペア1: [A][A]     または    [A][B]     など
ペア2: [A][B]              [A][A]
```
- 使用色数: 2色
- 特徴: メイン色の土台 + アクセント色

#### 3. ABAB型・AABB型（2色交互・2色ペア）
```
ABAB型:           AABB型:
ペア1: [A][B]     ペア1: [A][A]
ペア2: [A][B]     ペア2: [B][B]
```
- 使用色数: 2色
- 特徴: バランス良く、連鎖に使いやすい

#### 4. ABAC型（A色2個 + B色1個 + C色1個）
```
ペア1: [A][B]
ペア2: [A][C]
```
- 使用色数: 3色
- 特徴: メイン色1つ + サブ色2つ

#### 5. AABC型（A色2個 + B色1個 + C色1個、配置違い）
```
ペア1: [A][A]
ペア2: [B][C]
```
- 使用色数: 3色  
- 特徴: 連続する同色ペア + 異色ペア

## 実装詳細

### 生成アルゴリズム
1. 5つのパターンからランダムに1つを選択
2. 4色（赤・緑・青・黄）からランダムに必要な色を選択
3. パターンに応じて各ぷよペアに色を割り当て
4. AAAB型では、Bの位置をランダム化
5. ABAB型では、ABABとAABBをランダム選択

### コード構造
```typescript
// src/game/PuyoPair.ts
class PuyoPairManager {
  // 制約付き2手目生成
  static createValidTwoHandCombination(): { pair1: PuyoPair; pair2: PuyoPair }
  
  // 従来のランダム生成（nextNextPair用）
  static createRandomPair(): PuyoPair
}
```

### 使用箇所
- **ゲーム開始時**: 初期currentPair、nextPair
- **ペア消費後**: 新しい2手目組み合わせ生成
- **リセット時**: 新しい制約付き組み合わせで再開

## ゲームへの影響

### 戦略性の向上
- **色の偏り制御**: 自然な色分布
- **計画的な配置**: 限られた色組み合わせでの戦略構築
- **現実的な練習**: 実際のぷよぷよに近い環境

### GTR構築への影響
- **土台作り**: AAAA、AAAB型で安定した基盤
- **連鎖構築**: ABAB、ABAC型で効率的な連鎖
- **色管理**: 最大3色までの制約でシンプルな戦略

## 統計情報

### パターン出現確率
各パターンは等確率（20%）で選択されます：
- AAAA型: 20%
- AAAB型: 20%
- ABAB型: 20%（ABAB・AABB各10%）
- ABAC型: 20%
- AABC型: 20%

### 色数分布
- 1色のみ: 20%（AAAA型）
- 2色: 40%（AAAB型、ABAB型）
- 3色: 40%（ABAC型、AABC型）
- 4色: 0%（制約により不可能）

## 比較：制約なし vs 制約あり

| 項目 | 制約なし | 制約あり |
|------|----------|----------|
| 色数の最大 | 4色 | 3色 |
| パターン数 | 無制限 | 5種類 |
| 戦略の複雑さ | 高い | 適度 |
| 学習効果 | 困難 | 効率的 |
| 現実性 | 低い | 高い |

## 今後の拡張可能性

### 追加できる機能
- **パターン重み調整**: 特定パターンの出現確率変更
- **統計表示**: プレイヤーのパターン使用率表示
- **パターン指定練習**: 特定パターンのみでの練習モード

### 考慮事項
- **バランス調整**: パターンごとの難易度差
- **学習曲線**: 初心者向けの段階的制約解除
- **上級者対応**: より複雑な制約パターンの追加

---

この制約により、GTRトレーニングツールはより実戦的で効果的な学習環境を提供します。